<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏•‡∏´‡∏¥‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        #edit-modal.hidden { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-stone-100">

    <div class="container mx-auto px-4 py-10">
        <div class="max-w-4xl mx-auto mb-4 flex justify-between items-center no-print">
            <a id="back-link" href="order-history.html" class="text-stone-500 hover:text-stone-800 transition-colors">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</a>
            <div class="flex flex-wrap gap-2 justify-end">
                <a id="edit-order-items-link" href="#" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
                <button id="open-edit-status-modal-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                <a id="print-receipt-link" href="#" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (58mm)</a>
                <a id="print-address-link" href="#" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</a>
                <button onclick="window.print()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">‡∏û‡∏¥‡∏°‡∏û‡πå (A4)</button>
            </div>
        </div>

        <div id="print-area" class="max-w-4xl mx-auto bg-white p-8 md:p-10 rounded-xl shadow-lg">
            <div id="loader" class="text-center py-10"><p class="text-stone-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...</p></div>
            <div id="order-content" class="hidden">
                <header class="flex justify-between items-start pb-6 border-b">
                    <div>
                        <h1 class="text-3xl font-bold text-stone-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
                        <p id="order-date" class="text-stone-600 mt-1"></p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold">KAWANWA OFFICIAL</p>
                        <p class="text-sm text-stone-500">Handmade Bracelet</p>
                    </div>
                </header>

                <section class="grid grid-cols-1 md:grid-cols-2 gap-8 my-6">
                    <div>
                        <h2 class="font-semibold text-stone-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á</h2>
                        <p id="customer-name" class="text-stone-800"></p>
                        <p id="customer-contact" class="text-sm text-stone-600"></p>
                    </div>
                    <div class="bg-sky-50 p-4 rounded-lg">
                        <h2 class="font-semibold text-sky-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>
                        <p id="recipient-name" class="font-bold text-sky-900"></p>
                        <p id="recipient-address" class="text-sm text-sky-700 whitespace-pre-line"></p>
                        <p id="recipient-phone" class="text-sm text-sky-700 mt-2"></p>
                    </div>
                </section>

                <section class="my-6 border-t pt-6">
                    <h2 class="text-xl font-bold text-stone-800 mb-4">‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥)</h2>
                    <div id="product-details-display" class="mb-4 bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                                <p id="product-type" class="text-lg font-bold text-gray-800"></p>
                            </div>
                            <div id="necklace-details-display" class="hidden text-right">
                                <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏£‡πâ‡∏≠‡∏¢</p>
                                <p id="necklace-rings" class="text-lg font-bold text-gray-800"></p>
                                <p id="necklace-chain" class="text-md font-semibold text-gray-700 mt-1"></p>
                            </div>
                        </div>
                    </div>
                    <div id="materials-recipe-container" class="space-y-4">
                        <!-- Content will be generated by JS -->
                    </div>
                    <div id="bracelet-note-display" class="mt-4 text-sm text-stone-600 bg-stone-50 p-3 rounded-lg italic"></div>
                </section>


                <section class="my-6 grid grid-cols-1 md:grid-cols-2 gap-8 border-t pt-6">
                    <div class="bg-red-50 p-4 rounded-lg"><h2 class="font-bold text-red-800 mb-3 text-lg">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h2><div class="space-y-2 text-sm"><div class="flex justify-between"><span class="text-stone-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏´‡∏¥‡∏ô‡∏£‡∏ß‡∏°:</span><span id="cost-stones" class="font-semibold"></span></div><div class="flex justify-between"><span class="text-stone-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏ß‡∏°:</span><span id="cost-decorations" class="font-semibold"></span></div><div class="flex justify-between"><span class="text-stone-600">‡∏Ñ‡πà‡∏≤‡∏•‡∏ß‡∏î:</span><span id="cost-wire" class="font-semibold"></span></div><div class="flex justify-between pb-2 border-b border-dashed"><span class="text-stone-600">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á:</span><span id="cost-labor" class="font-semibold"></span></div><div class="flex justify-between font-bold pt-2"><span class="text-red-700">‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span><span id="cost-total-items" class="text-red-700"></span></div></div></div>
                    <div class="bg-green-50 p-4 rounded-lg"><h2 class="font-bold text-green-800 mb-3 text-lg">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h2><div id="free-order-banner" class="hidden text-center bg-rose-100 text-rose-700 font-bold p-2 rounded-md mb-3">*** ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ü‡∏£‡∏µ ***</div><div class="space-y-2 text-sm"><div class="flex justify-between"><span class="text-stone-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span><span id="summary-selling-price" class="font-semibold"></span></div><div class="flex justify-between"><span class="text-stone-600">‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</span><span id="summary-shipping-cost" class="font-semibold"></span></div><div class="flex justify-between font-bold text-lg pt-2 pb-2 border-y border-dashed"><span class="text-stone-800">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span><span id="summary-grand-total" class="text-stone-800"></span></div><div class="flex justify-between pt-2"><span class="text-stone-600">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥:</span><span id="summary-deposit" class="font-semibold text-green-600"></span></div><div class="flex justify-between font-bold text-xl text-red-600"><span class="">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span><span id="summary-balance-due"></span></div><div class="flex justify-between font-bold text-xl text-green-700 mt-4 pt-4 border-t-2"><span class="">‡∏Å‡∏≥‡πÑ‡∏£:</span><span id="summary-profit"></span></div></div></div>
                </section>
                <section class="mt-8 pt-6 border-t text-center grid grid-cols-2 gap-4">
                    <div><p class="text-sm text-stone-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p><div id="payment-status-display" class="mt-1"></div></div>
                    <div><p class="text-sm text-stone-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p><div id="processing-status-display" class="mt-1"></div></div>
                    <div id="tracking-number-display" class="col-span-2 hidden"><p class="text-sm text-stone-500">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</p><p id="tracking-number" class="font-bold text-lg text-blue-600"></p></div>
                </section>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div id="modal-panel" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"><form id="edit-status-form" class="p-6 md:p-8"><header class="flex justify-between items-start mb-6 pb-4 border-b"><h2 class="text-2xl font-bold text-stone-800">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2><button type="button" id="close-modal-btn" class="p-1 rounded-full hover:bg-stone-200 transition-colors"><svg class="w-6 h-6 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></header><div class="space-y-6"><div class="bg-stone-50 p-4 rounded-lg"><h3 class="font-semibold text-stone-700 mb-2">1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3><div class="space-y-3"><select id="payment-status-select" class="w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm"><option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞</option><option value="‡∏°‡∏±‡∏î‡∏à‡∏≥">‡∏°‡∏±‡∏î‡∏à‡∏≥</option><option value="‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option></select><div id="deposit-amount-container" class="hidden"><label for="deposit-amount-input" class="block text-sm font-medium text-stone-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥</label><input type="number" id="deposit-amount-input" class="w-full px-3 py-2 border border-stone-300 rounded-md"></div></div></div><div class="bg-stone-50 p-4 rounded-lg"><h3 class="font-semibold text-stone-700 mb-2">2. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3><div class="space-y-3"><select id="processing-status-select" class="w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm"><option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option><option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option><option value="‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</option></select><div id="tracking-number-container" class="hidden"><label for="tracking-number-input" class="block text-sm font-medium text-stone-700 mb-1">‡πÄ‡∏•‡∏Ç Tracking</label><input type="text" id="tracking-number-input" class="w-full px-3 py-2 border border-stone-300 rounded-md"></div></div></div></div><div class="mt-6 pt-6 border-t"><button type="submit" id="save-changes-btn" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg px-5 py-2.5 text-center transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from './config.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const formatCurrency = (number) => (number || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‡∏ø';
            const modal = document.getElementById('edit-modal');
            const openEditStatusModalBtn = document.getElementById('open-edit-status-modal-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const editStatusForm = document.getElementById('edit-status-form');
            const paymentStatusSelect = document.getElementById('payment-status-select');
            const depositAmountContainer = document.getElementById('deposit-amount-container');
            const depositAmountInput = document.getElementById('deposit-amount-input');
            const processingStatusSelect = document.getElementById('processing-status-select');
            const trackingNumberContainer = document.getElementById('tracking-number-container');
            const trackingNumberInput = document.getElementById('tracking-number-input');
            let currentOrderData = null;

            const getPaymentStatusBadge = (status) => {
                if (status === '‡∏ü‡∏£‡∏µ') return `<span class="bg-rose-100 text-rose-800 text-lg font-bold px-3 py-1 rounded-full">${status}</span>`;
                switch (status) { case '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß': return `<span class="bg-green-100 text-green-800 text-lg font-bold px-3 py-1 rounded-full">${status}</span>`; case '‡∏°‡∏±‡∏î‡∏à‡∏≥': return `<span class="bg-yellow-100 text-yellow-800 text-lg font-bold px-3 py-1 rounded-full">${status}</span>`; default: return `<span class="bg-blue-100 text-blue-800 text-lg font-bold px-3 py-1 rounded-full">${status || 'N/A'}</span>`; }
            };
            const getProcessingStatusBadge = (status) => {
                switch (status) { case '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß': return `<span class="bg-teal-100 text-teal-800 text-lg font-bold px-3 py-1 rounded-full">${status}</span>`; case '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': return `<span class="bg-purple-100 text-purple-800 text-lg font-bold px-3 py-1 rounded-full">${status}</span>`; default: return `<span class="bg-stone-200 text-stone-800 text-lg font-bold px-3 py-1 rounded-full">${status || 'N/A'}</span>`; }
            };
            const openModal = () => modal.classList.remove('hidden');
            const closeModal = () => modal.classList.add('hidden');

            const createRecipeSubTable = (title, items) => {
                if (!items || items.length === 0) return '';
                
                let tableRows = items.map(item => `
                    <tr class="bg-white border-b hover:bg-stone-50">
                        <td class="px-4 py-2 font-medium text-stone-900">${item.name}</td>
                        <td class="px-4 py-2 text-center">${item.size || '-'}</td>
                        <td class="px-4 py-2 text-center font-bold text-sky-600">${item.quantity}</td>
                    </tr>
                `).join('');

                return `
                    <div>
                        <h3 class="font-semibold text-md text-stone-600 mb-2">${title}</h3>
                        <table class="w-full text-sm text-left text-stone-700">
                            <thead class="text-xs text-stone-700 uppercase bg-stone-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
                                    <th scope="col" class="px-4 py-3 text-center">‡∏Ç‡∏ô‡∏≤‡∏î (mm)</th>
                                    <th scope="col" class="px-4 py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            const renderMaterialsRecipe = (bracelet, materialsMap) => {
                const container = document.getElementById('materials-recipe-container');
                const usedMaterials = bracelet.usedMaterials;
                container.innerHTML = '';

                if (!usedMaterials || usedMaterials.length === 0) {
                    container.innerHTML = '<p class="text-stone-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</p>';
                    return;
                }

                const stones = [];
                const decorations = [];

                usedMaterials.forEach(mat => {
                    const materialInfo = materialsMap.get(mat.materialId) || {};
                    const itemData = {
                        name: mat.name,
                        size: materialInfo.size,
                        quantity: mat.quantityUsed
                    };
                    if (materialInfo.type === '‡∏´‡∏¥‡∏ô') {
                        stones.push(itemData);
                    } else if (materialInfo.type === '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á') {
                        decorations.push(itemData);
                    }
                });

                container.innerHTML += createRecipeSubTable('üíé ‡∏´‡∏¥‡∏ô', stones);
                container.innerHTML += createRecipeSubTable('‚ú® ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á', decorations);

                if (bracelet.wireType) {
                    container.innerHTML += `
                        <div class="mt-4">
                            <h3 class="font-semibold text-md text-stone-600 mb-2">‚õìÔ∏è ‡∏•‡∏ß‡∏î</h3>
                            <p class="text-sm text-stone-800 bg-stone-50 p-3 rounded-md">${bracelet.wireType}</p>
                        </div>
                    `;
                }
            };

            async function loadOrderDetails() {
                const loader = document.getElementById('loader');
                const content = document.getElementById('order-content');
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('orderId');
                if (!orderId) { loader.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"; return; }
                document.getElementById('edit-order-items-link').href = `edit-order.html?orderId=${orderId}`;
                document.getElementById('print-receipt-link').href = `print-receipt.html?orderId=${orderId}`;
                document.getElementById('print-address-link').href = `print-shipping-label.html?orderId=${orderId}`;
                try {
                    const orderRef = doc(db, "orders", orderId);
                    const orderSnap = await getDoc(orderRef);
                    if (!orderSnap.exists()) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ");
                    currentOrderData = orderSnap.data();
                    const [braceletSnap, customerSnap, materialsSnap] = await Promise.all([
                        getDoc(doc(db, "bracelets", currentOrderData.braceletId)),
                        getDoc(doc(db, "customers", currentOrderData.customerId)),
                        getDocs(collection(db, "materials"))
                    ]);
                    if (!braceletSnap.exists() || !customerSnap.exists()) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡πÑ‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
                    const bracelet = braceletSnap.data(), customer = customerSnap.data();
                    const materialsMap = new Map();
                    materialsSnap.forEach(doc => materialsMap.set(doc.id, doc.data()));
                    
                    document.getElementById('order-date').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${currentOrderData.orderDate.toDate().toLocaleDateString('th-TH', { dateStyle: 'long' })}`;
                    document.getElementById('customer-name').textContent = customer.name;
                    document.getElementById('customer-contact').textContent = `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${customer.phone || customer.contactChannel || '-'}`;
                    document.getElementById('recipient-name').textContent = currentOrderData.recipientName || customer.name;
                    document.getElementById('recipient-address').textContent = currentOrderData.recipientAddress || customer.shippingAddress || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
                    document.getElementById('recipient-phone').textContent = `‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${currentOrderData.recipientPhone || customer.phone || '-'}`;
                    
                    const productTypeEl = document.getElementById('product-type');
                    const necklaceDetailsContainer = document.getElementById('necklace-details-display');
                    const necklaceRingsEl = document.getElementById('necklace-rings');
                    const necklaceChainEl = document.getElementById('necklace-chain');
                    
                    const productType = bracelet.productType || '‡∏Å‡∏≥‡πÑ‡∏•';
                    productTypeEl.textContent = productType;

                    if (productType === '‡∏™‡∏£‡πâ‡∏≠‡∏¢' && bracelet.necklaceDetails) {
                        necklaceRingsEl.textContent = `${bracelet.necklaceDetails.rings} ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô`;
                        if (bracelet.necklaceDetails.chainType) {
                            let chainText = `‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ${bracelet.necklaceDetails.chainType}`;
                            if (bracelet.necklaceDetails.chainType === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && bracelet.necklaceDetails.chainTypeOther) {
                                chainText += ` (${bracelet.necklaceDetails.chainTypeOther})`;
                            }
                            necklaceChainEl.textContent = chainText;
                        }
                        necklaceDetailsContainer.classList.remove('hidden');
                    } else {
                        necklaceDetailsContainer.classList.add('hidden');
                    }
                    
                    renderMaterialsRecipe(bracelet, materialsMap);

                    if (bracelet.note) {
                        document.getElementById('bracelet-note-display').textContent = `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${bracelet.note}`;
                        document.getElementById('bracelet-note-display').style.display = 'block';
                    } else {
                        document.getElementById('bracelet-note-display').style.display = 'none';
                    }

                    const laborCost = bracelet.laborCost || 0, wireCost = bracelet.wireCost || 0, shippingCost = currentOrderData.shippingCost || 0, sellingPrice = bracelet.sellingPrice || 0, depositAmount = currentOrderData.depositAmount || 0;
                    const totalItemCost = currentOrderData.totalCost || 0;
                    const profit = currentOrderData.profit || 0;
                    const grandTotal = sellingPrice + shippingCost;
                    let balanceDue = (currentOrderData.paymentStatus === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞') ? grandTotal : (currentOrderData.paymentStatus === '‡∏°‡∏±‡∏î‡∏à‡∏≥' ? grandTotal - depositAmount : 0);
                    
                    let totalStoneCost = 0, totalDecorationCost = 0;
                     bracelet.usedMaterials.forEach(mat => {
                        const materialInfo = materialsMap.get(mat.materialId);
                        const itemTotalCost = (materialInfo?.avgPricePerPiece || 0) * mat.quantityUsed;
                        if (materialInfo?.type === '‡∏´‡∏¥‡∏ô') { totalStoneCost += itemTotalCost; }
                        else { totalDecorationCost += itemTotalCost; }
                    });
                    document.getElementById('cost-stones').textContent = formatCurrency(totalStoneCost);
                    document.getElementById('cost-decorations').textContent = formatCurrency(totalDecorationCost);
                    document.getElementById('cost-wire').textContent = formatCurrency(wireCost);
                    document.getElementById('cost-labor').textContent = formatCurrency(laborCost);
                    document.getElementById('cost-total-items').textContent = formatCurrency(totalItemCost);

                    document.getElementById('summary-selling-price').textContent = formatCurrency(sellingPrice);
                    document.getElementById('summary-shipping-cost').textContent = formatCurrency(shippingCost);
                    document.getElementById('summary-grand-total').textContent = formatCurrency(grandTotal);
                    document.getElementById('summary-deposit').textContent = `- ${formatCurrency(depositAmount)}`;
                    document.getElementById('summary-balance-due').textContent = formatCurrency(balanceDue);
                    document.getElementById('summary-profit').textContent = formatCurrency(profit);
                    document.getElementById('free-order-banner').style.display = bracelet.isFree ? 'block' : 'none';
                    document.getElementById('payment-status-display').innerHTML = getPaymentStatusBadge(currentOrderData.paymentStatus);
                    document.getElementById('processing-status-display').innerHTML = getProcessingStatusBadge(currentOrderData.processingStatus);
                    document.getElementById('tracking-number-display').classList.toggle('hidden', !(currentOrderData.processingStatus === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' && currentOrderData.trackingNumber));
                    if(currentOrderData.trackingNumber) document.getElementById('tracking-number').textContent = currentOrderData.trackingNumber;
                    loader.classList.add('hidden'); content.classList.remove('hidden');
                } catch (error) { console.error("Error loading order details:", error); loader.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`; }
            }
            openEditStatusModalBtn.addEventListener('click', () => {
                if (!currentOrderData) return;
                paymentStatusSelect.value = currentOrderData.paymentStatus || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞';
                processingStatusSelect.value = currentOrderData.processingStatus || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                depositAmountInput.value = currentOrderData.depositAmount || 0;
                trackingNumberInput.value = currentOrderData.trackingNumber || '';
                paymentStatusSelect.dispatchEvent(new Event('change'));
                processingStatusSelect.dispatchEvent(new Event('change'));
                openModal();
            });
            editStatusForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const orderId = new URLSearchParams(window.location.search).get('orderId');
                if (!orderId) return;
                const dataToUpdate = { paymentStatus: paymentStatusSelect.value, processingStatus: processingStatusSelect.value, depositAmount: parseFloat(depositAmountInput.value) || 0, trackingNumber: trackingNumberInput.value, };
                await updateDoc(doc(db, "orders", orderId), dataToUpdate);
                closeModal();
                loadOrderDetails();
            });
            paymentStatusSelect.addEventListener('change', (e) => depositAmountContainer.classList.toggle('hidden', e.target.value !== '‡∏°‡∏±‡∏î‡∏à‡∏≥'));
            processingStatusSelect.addEventListener('change', (e) => trackingNumberContainer.classList.toggle('hidden', e.target.value !== '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'));
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            loadOrderDetails();
        });
    </script>
</body>
</html>
